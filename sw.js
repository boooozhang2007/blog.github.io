(()=>{const t="kmarBlogCache",e="https://id.v3/",n=()=>caches.match(e).then((t=>t?.json())),s=n=>caches.open(t).then((t=>t.put(e,new Response(JSON.stringify(n)))));self.addEventListener("install",(()=>{self.skipWaiting()})),self.addEventListener("activate",(t=>t.waitUntil(clients.claim())));let a={simple:{clean:!0,search:!1,match:t=>"blog.saop.cc"===t.host&&t.pathname.match(/\.(woff2|woff|ttf|cur)$/)}},r=t=>{if(t.startsWith("https://npm.elemecdn.com")){const e=new URL(t);return[t,"https://registry.npmmirror.com"+e.pathname,"https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M"+e.pathname,"https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M"+e.pathname,"https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M"+e.pathname,"https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M"+e.pathname,"https://cdn.staticfile.org"+e.pathname,"https://cdn.chuqis.com/npm"+e.pathname,"https://jsd.onmicrosoft.cn/npm"+e.pathname,"https://npm.onmicrosoft.cn"+e.pathname,"https://cdnjs.onmicrosoft.cn/ajax/libs"+e.pathname,"https://font.onmicrosoft.cn"+e.pathname,"https://unpkg.com"+e.pathname,"https://cdn.jsdelivr.net/npm"+e.pathname,"https://fastly.jsdelivr.net/npm"+e.pathname]}};const c=(t,e,n)=>{if(n||(n=r(t.url)),!n||!Promise.any)return p(t,e);const s=n.map((e=>new Request(e,t))),a=new Array(s.length);return Promise.any(s.map(((t,n)=>p(t,e,{signal:(a[n]=new AbortController).signal}).then((t=>o(t)?{index:n,response:t}:Promise.reject()))))).then((t=>{for(let e in a)e!==t.index&&a[e].abort();return t.response}))},o=t=>t.ok||[301,302,307,308].includes(t.status),h=new Map;self.addEventListener("fetch",(e=>{let n=e.request,s=new URL(n.url);if("GET"!==n.method||!n.url.startsWith("http"))return;let a,i=s.hostname+s.pathname+s.search;const p=t=>{e.respondWith(a?t.then((t=>{for(let e of a)e(t.clone())})).catch((t=>{for(let e of a)e(t)})).then((()=>(h.delete(i),t))):t)},m=f(s);if(m){let e=`https://${s.host}${s.pathname}`;e.endsWith("/index.html")&&(e=e.substring(0,e.length-10)),m.search&&(e+=s.search),p(caches.match(e).then((s=>s??c(n,!0).then((n=>{if(o(n)){const s=n.clone();caches.open(t).then((t=>t.put(e,s)))}return n})))))}else{const t=r(n.url);p(t?c(n,!1,t):l(n).catch((t=>new Response(t,{status:499}))))}})),self.addEventListener("message",(t=>{"update"===t.data&&m().then((e=>{e.type="update",t.source.postMessage(e)}))}));const i=(t,e,n,s)=>(s||(s={}),s.cache=e?"no-store":"default",n&&(s.mode="cors",s.credentials="same-origin"),fetch(t,s)),l=(t,e)=>i(t,!1,!1,e),p=(t,e,n)=>i(t,e,!0,n),f=t=>{if("localhost"!==t.hostname)for(let e in a){const n=a[e];if(n.match(t))return n}},m=async()=>{const a=await c(new Request("/update.json"),!1);if(!o(a))throw`加载 update.json 时遇到异常，状态码：${a.status}`;const r=await a.json(),h=await(t=>n().then((e=>{const{info:n,global:a}=t,r={global:a,local:n[0].version,escape:e?.escape??0};if(!e)return r.escape=0,s(r),{new:r,old:e};let c=new u,o=((t,e,n)=>{for(let s of e){const{version:e,change:a}=s;if(e===n)return!1;if(a)for(let e of a)t.push(new d(e))}return!0})(c,n,e.local);return s(r),o&&(a!==e.global?c.force=!0:c.refresh=!0),{list:c,new:r,old:e}})))(r);if(h.list){const n=await(n=>caches.open(t).then((t=>t.keys().then((s=>Promise.all(s.map((async s=>{const a=s.url;return a!==e&&n.match(a)?(t.delete(s),a):null}))))).then((t=>t.filter((t=>t)))))))(h.list);h.list=n?.length?n:null}return h};function u(){const t=[];this.push=e=>{t.push(e)},this.match=e=>{if(this.force)return!0;if(e=new URL(e),this.refresh)return f(e).clean;for(let n of t)if(n.match(e))return!0;return!1}}function d(t){const e=e=>{const n=t.value;if(Array.isArray(n)){for(let t of n)if(e(t))return!0;return!1}return e(n)};this.match=(()=>{switch(t.flag){case"html":return t=>t.pathname.match(/(\/|\.html)$/);case"end":return t=>e((e=>t.href.endsWith(e)));case"begin":return t=>e((e=>t.pathname.startsWith(e)));case"str":return t=>e((e=>t.href.includes(e)));case"reg":return t=>e((e=>t.href.match(new RegExp(e,"i"))));default:throw`未知表达式：${JSON.stringify(t)}`}})()}})();